<!DOCTYPE html>
<html>
  <head>
    <link href="https://fonts.googleapis.com/css?family=Press+Start+2P" rel="stylesheet">
    <script type="text/javascript" src="../../js/jquery-3.2.1.min.js"></script>
    <meta charset="UTF-8">
    <style>
    body{
      background: black;
      position: relative;
      color:white;
    }
    div,hidden{
      bottom: 0px;
      right:0px;
      font-size: 8px;
      font-family: 'Press Start 2P', cursive;
      color: #00FF00;
      display: inline;
    }

    </style>
  </head>

  <body>

  </body>
  <script type="text/javascript" src="js/util.js"></script>
    <script type="text/javascript" src="js/mixup.js"></script>
    <script type="text/javascript" src="dict.txt"></script>

  <script>
      // Constants
      fillers = ["an", "this.", "this", "but", "I", "of", "to", "and",
      "in", "at", "the", "", "that", "on", "a", "if", "you"]


      function FindIPosts(post, spans){
        beginning = post.slice(0,3)
        if (beginning.indexOf("I ") !== -1){
          var result = post.match( /[^\.!\?]+[\.!\?]+/g );
          if (result != null){
            spans.push(result[0])
          }
        }
      }

      function ScrapePosts(entries){
        var spans = []
        for (var i = 0; i < entries.length; i++){
           if (entries[i].length > 10){
            var limbs = entries[i].split("***");
            post = limbs[1]
            FindIPosts(post, spans)
          }
        }
        return spans
      }

      function CreateBreakDomElement(){
        var body = document.getElementsByTagName('body')[0]
        var br = document.createElement('br')
        body.appendChild(br)
      }

      function CreateDivDomElement(){
        var body = document.getElementsByTagName('body')[0]
        var div = document.createElement('div')
        body.appendChild(div)
        return div
      }
      function CreateHiddenDomElement(){
        var body = document.getElementsByTagName('body')[0]
        var div = document.createElement('hidden')
        div.id="hidden"

        var q = div.textContent
        url = 'http://google.com/search?q='+div.textContent+'&source=lnms&tbm=isch&sa=X&ved=0ahUKEwiD2PvWgYfXAhXHWCYKHb2wCWcQ_AUICygC'
        div.onclick = function() { window.open(url, "seven") };


        body.appendChild(div)
        return div
      }

      function TypeSet(spans, i){
        var div = document.getElementsByTagName('div')
        div = div[div.length-1]
        div.textContent = div.textContent.slice(0, div.textContent.length-1)
        div.textContent = div.textContent + spans[i]
        div.textContent = div.textContent + "_"
      }
      function TypeSetHidden(spans, i){
        var div = document.getElementsByTagName('hidden')
        div = div[div.length-1]
        div.textContent = div.textContent.slice(0, div.textContent.length-1)
        div.textContent = div.textContent + spans[i]
        div.textContent = div.textContent + "_"
      }

      function TypeSetReset(spans, i, hidden){
          var div = document.getElementsByTagName('div')
          div = div[div.length-1]
          div.textContent = div.textContent.slice(0, div.textContent.length-1)
      }

      function EliminateFiller(sentence){
        var possibilities = []
        for (var t = 0; t < sentence.length; t++){
          word = sentence[t]
          if (fillers.indexOf(word) == -1){
            possibilities.push(word)
          }
        }
        return possibilities
      }

      function RandomWordIndex(possibilities, sentence){
        var r = Math.floor(Math.random() * (possibilities.length-1)+1);
        var word = possibilities[r]
        var index = sentence.indexOf(word);
        return index;
      }

      function PushRandomWord(possibilities, sentence, index){
        word = sentence[index]
        sentence[index] = "~"+sentence[index]+"%"
        random_words.push(sentence.join(' '))
      }

      jQuery.get('/raw_db', function(data) {
        var body = document.getElementsByTagName('body')[0]
        var i = 0;
        random_words = []
        var k = 0

        var entries = SplitEntries(data)
        var spans = ScrapePosts(entries);


        while(random_words.length < spans.length){
          sentence = spans[k].split(' ');
          possibilities = EliminateFiller(sentence)

          shuffle(possibilities);
          var index = RandomWordIndex(possibilities, sentence)
          PushRandomWord(possibilities, sentence, index)
          k++
        }
        spans = random_words.join(' ')
        spans = spans.slice(1,spans.length-1)

        jQuery.get('/raw_thesaurus', function(data) {
          entries = (data)
         });

        setInterval(function(){
          var body = document.getElementsByTagName('body')[0]

          if (i >= spans.length){
            console.log('reset')
            var myNode = document.getElementsByTagName("body")[0];
            while (myNode.firstChild) {
                myNode.removeChild(myNode.firstChild);
            }
            i = 0;
          }
          else{
            if (spans[i] == "I"){
              CreateBreakDomElement()
              CreateDivDomElement()
            }
            if(spans[i].indexOf("~") > -1){
              span = CreateHiddenDomElement()
              i++
              while(spans[i].indexOf("%") <= -1){
                TypeSetHidden(spans, i)
                i++
              }
              TypeSetReset()

              CreateDivDomElement()
            }
            else{
              TypeSet(spans, i)
            }
          }
          i++;

          var collections = document.getElementsByTagName('hidden')
          for(var j = 0; j < collections.length-1; j++){
            var text = collections[j].childNodes[0].textContent
            if (text.slice(1,2) == text.slice(1,2).toLowerCase()){
              // The character is lowercase
              text = text.slice(0, text.length-1)
            }
            var punctuationless = text.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"");
            var finalString = punctuationless.replace(/\s{2,}/g," ");
            text = finalString;
            dict = (entries[text.toUpperCase()])
            if (dict != undefined){
              var r = Math.floor(Math.random() * (dict.length-1)+1);

              var test = dict[r]
              for (var key in test) {
                    collections[j].childNodes[0].textContent = key
              }


            }
          }



        }, 100);
    })







  </script>
</html>
